# Домашняя работа к пятому спринту второго модуля курса Yandex Practicum
---
## Что внутри
### MVC контроллеры

- **ItemController** (`/items`):
    - `GET /items` — витрина товаров, параметры:
            search - поисковая строка;
            sort (ALPHA/PRICE/NO) - сортировка товаров;
            pageNumber, pageSize - параметры постраничного отображения.
    - `GET /items/{id}` — карточка товара с соответствующим ID.
    - `POST /items` — изменение количества товаров в коззине, параметры:
            id - уникальный идентификатор товара;
            search - поиковая строка;
            sort (ALPHA/PRICE/NO) - сортировка товаров;
            pageNumber, pageSize - параметры постраничного отображения;
            action (PLUS/MINUS/DELETE/NOTHING) - команды управления счетчиком.

- **CartController**  (`/cart`):  
    - `GET /cart/items` — отобразить содержимое корзины.
    - `POST /cart/items` — изменить количество товаров в корзине, параметры:
            id - уникальный идентификатор товара;
            action (PLUS/MINUS/DELETE/NOTHING) - команды управления счетчиком.
    - `GET /cart/items/{id}` — карточка товара в корзине:
            id - уникальный идентификатор товара.
    - `POST /cart/items/{id}` — редактировать конкретное сообщение, параметры:
            id - уникальный идентификатор товара;
            action (PLUS/MINUS/DELETE/NOTHING) - команды управления счетчиком.

- **OrderController**  (`/orders`):
    - `GET /orders` — получить список заказов.
    - `GET /orders/{id}` — карточка заказа
            id - уникальный идентификатор товара;
            newOrder (true/false) - признак нового заказа 

- **UserController** (`/`):
    - `GET /` — redirect на `GET /items` эндпоинт витрины товаров
    - `POST /buy"` — совершение покупки 

---
### Сборка проекта
  
 - `gradle clean build` - компилирует файлы, запускает тесты и генерирует файл .jar в папке build/lib/
---
### Быстрый старт (только тесты)

- `gradle test`  - запускаем тесты
---
### Запуск приложения (1 вариант)

- `docker compose build` - в папке проекта выполняем команду сборки образов контейнеров, необходимых для запуска приложения
- `docker compose up` - в папке проекта выполняем команду развертывания контейнеров PostgreSQL, Nginx и приложения. Проект становится доступным по адресу 'http://localhost/'  


### Запуск приложения (2 вариант)

- `docker run --name yp-database --rm --net practicum-network --env-file postgres.env -p 5432:5432 -v modile_two_postgres_data:/var/lib/postgresql/18/docker2 postgres:18.1` - в папке проекта выполняем команду развертывания и запуска докерконтейнера с PostgreSQL.
- `gradle clean build bootRun` - запускаем приложение. Приложение поднимает вебсервер, и фронтэнд становится доступен по адресу 'http://localhost:8080/'  
---
### Требования к запуску

- `JDK21` - рабочая среда - JDK21, на более поздних версиях приложение не тестировалось
  

### Краткое описание
- Работа над проектом очень понравилась, получилось позаниматься многими инструментами, с которыми хотел разобраться. Docker - Liquibase/FlyWay - Testcontainers. Очень приятно, что все получилось, хотя времени на все ушло значительно больше, чем я и предполагал. 
- Для связи корзины и заказов пришлось придумать новую сущность - _**(User)**_ Пользователя. Да, это нарушение YAGNI, но так проще.
- Удалось попробовать работу с **_ENUM_**, пришлось позаниматься с конвертерами, было непросто. Иногда возникало желание отказаться от автоконфигурацию. Решение пришло, но его можно еще улучшить, оставлять конфигуратор в качестве бина - так себе решение.
- В работе пришлось столкнуться с проблемой циклических зависимостей. Поэтому прищлось отстроить ветки связей сервисов: большинство запросов поступают в репозитории по цепочке UserService -> ItemService -> (CartService|OrderService) -> (CartItenService|OrderItenService).      
---

### Что не удалось
- Не подогнал картнки по размеру, не успел
- Не вполне разобрался с автоконфигурациями
- На этапе тестирования пришлось аннотировать отношения Many-to-One отметкой EAGER, совсем не понравилось   
- @Transactional в тестах реально разочаровал, хотел использовать для отката изменений, но внутри тесты не работали с данными как надо. Или я еще с ним не разобрался 
- Проблема N+1. ПОзанимаюсь ею на следующей неделе. Честно говоря, не дошли руки

### Изменения в сравнении с работой четвертого спринта
- Много DevOps. Я в этом не разбирался раньше. 

### Что понравилось
- Docker
- Liquibase
- Data JPA, Data JDBC 
---

## Тестирование
По тестированию. Я несколько ограничил себя в творчестве тестов, если зря, пожалуйста, дайте знать. Хочется выйти на уровень TDD. 

### Что внутри

- **ItemControllerIntegrationTest** 
    - `findItemsByTitleOrDescription` — интеграционный тест на поиск товаров по названию или описанию
    - `getItemByIdSuccesfull` — интеграционный тест на поиск товара с корректным ID
    - `getItemByIdNotFound` — интеграционный тест на поиск товара с несуществующим ID
    - `testRequestSortParameterConverter` — модульный тест конвертера (string-ENUM)
    - `testRequestActionParameterConverter` — модульный тест конвертера + redirect

- **OrderRepositoryJpaTest**
    - `findOrdersByUserId` — проходной тест, созданный исключительно для создания инфраструктуры 

- **UserServiceLimitedIntegrationTest**
    - `testCloseChartByUserId` — интеграционный тест на взаимодействие уровня логики и DAO. Отработка сценария "Закрытие корзины и создание нового заказа"
    - `testChangeInCardCount` — сценарий "корректировка состава покупательской корзины" 
