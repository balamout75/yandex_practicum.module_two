<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="
          http://www.liquibase.org/xml/ns/dbchangelog
          http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.31.xsd">

    <changeSet id="add-sub-column-to-users" author="Ivan Vasilyev">

        <preConditions>
            <not>
                <columnExists tableName="users" columnName="sub"/>
            </not>
        </preConditions>

        <addColumn tableName="users">
            <column name="sub" type="varchar(255)"/>
        </addColumn>

        <update tableName="users">
            <column name="sub" value="resident"/>
        </update>

        <addNotNullConstraint
                tableName="users"
                columnName="sub"
                columnDataType="varchar(255)"/>

        <createIndex
                tableName="users"
                indexName="idx_users_sub"
                unique="true">
            <column name="sub"/>
        </createIndex>

        <rollback>
            <dropIndex tableName="users" indexName="idx_users_sub"/>
            <dropColumn tableName="users" columnName="sub"/>
        </rollback>

    </changeSet>

</databaseChangeLog>
